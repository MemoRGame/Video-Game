<html>
    <head>
        <meta charset="utf-8">
        <title>チャットサイト</title>
        <style>
            .userName{
    width:65vw;
    height:15vh;
    position:absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);  /* 要素の中心を画面の中央に移動 */
    border-width:1px;
    font-size:50px;
}

#TalkingStart {
    width: 65vw; /* ボタンの幅も入力フィールドと同じに */
    height: 15vh; /* ボタンの高さ */
    font-size: 10vh; /* フォントサイズ */
    position: absolute;
    top: calc(50% + 15vh); /* ユーザー名入力ボックスの下に配置 */
    left: 50%;
    transform: translateX(-50%); /* 横方向の中央揃え */
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}
    
/* ボタンがクリックされているとき（アクティブ時）のスタイル */
#TalkingStart:active {
    background-color: #388e3c;
    transform: scale(0.98); /* クリック時に少し縮小する */
    position: absolute;
    top: calc(50% + 15vh); /* ユーザー名入力ボックスの下に配置 */
    left: 50%;
    transform: translateX(-50%);
}

#TalkingSite{
    font-size: 8vw; /* フォントサイズ */
    position: absolute;
    top: calc(50% - 45vh); /* ユーザー名入力ボックスの下に配置 */
    left: 50%;
    transform: translateX(-50%); /* 横方向の中央揃え */
    color: black;
    border: none;
}

#helloID{
    font-size:5vh;
}

/* トークボックスの基本スタイル */
.chat-box {
    width:85vw;                /* 横幅 */
    height: 60vh;               /* 高さ */
    border: 2px solid #ccc;      /* 枠線 */
    padding: 1vw;               /* 内側の余白 */
    background-color: #f9f9f9;   /* 背景色 */
    overflow-y: auto;            /* 縦方向にスクロールできる */
    overflow-x: hidden;          /* 横方向のスクロールは隠す */
    position: relative;          /* 相対位置でスクロール位置を調整 */
    display: none;
    position: absolute;
    top: calc(15vh); /* ユーザー名入力ボックスの下に配置 */
    left: 45%;
    transform: translateX(-50%); /* 横方向の中央揃え */
}

/* トークボックスの基本スタイル */
.userlist {
    width:10vw;                /* 横幅 */
    height: 60vh;               /* 高さ */
    border: 2px solid #ccc;      /* 枠線 */
    padding: 1vw;               /* 内側の余白 */
    background-color: #f9f9f9;   /* 背景色 */
    overflow-y: auto;            /* 縦方向にスクロールできる */
    overflow-x: hidden;          /* 横方向のスクロールは隠す */
    position: relative;          /* 相対位置でスクロール位置を調整 */
    display: none;
    position: absolute;
    top: calc(15vh); /* ユーザー名入力ボックスの下に配置 */
    left: 88%;
    transform: translat_eX(-50%); /* 横方向の中央揃え */
}

.MessageText {
    width:95vw;                /* 横幅 */
    height: 10vh;               /* 高さ */
    border: 2px solid black;      /* 枠線 */
    padding: 1vw;               /* 内側の余白 */
    background-color: #f9f9f9;   /* 背景色 */
    overflow-y: auto;            /* 縦方向にスクロールできる */
    overflow-x: hidden;          /* 横方向のスクロールは隠す */
    position: relative;          /* 相対位置でスクロール位置を調整 */
    display: none;
    position: absolute;
    top: calc(75vh); /* ユーザー名入力ボックスの下に配置 */
    left: 50%;
    transform: translateX(-50%); /* 横方向の中央揃え */
    font-size:5vh;
}

#roomDetail{
    padding: 1vw;               /* 内側の余白 */
    display: none;
    position: absolute;
    top: calc(80vh); /* ユーザー名入力ボックスの下に配置 */
    left: 2%;
    font-size:3vh;  
}

#roomID{  
    width:35vw;          /* 横幅 */
    height: 5vh;               /* 高さ */
    border: 2px solid black;      /* 枠線 */
    background-color: #f9f9f9;   /* 背景色 */
    display: none;
    position: absolute;
    top: calc(90vh); /* ユーザー名入力ボックスの下に配置 */
    left: 2.5%;
    font-size:3vh;
}

.join{
    width:10vw;             /* 横幅 */
    height: 5vh;               /* 高さ */
    border: 2px solid black;      /* 枠線 */
    background-color: #f9f9f9;   /* 背景色 */
    display: none;
    position: absolute;
    top: calc(90vh); /* ユーザー名入力ボックスの下に配置 */
    left: 37%;
    text-align: center;
    font-size:3vh;
}

.msg-class-match{
    position: absolute; /* 絶対位置 */
    right: 0; /* 右端に配置 */
  background-color: #eee; /* 灰色 */
  padding: 5px; /* 文字周りの余白 */
  border-radius: 10px; /* 角丸 */
}

.name-class-match{
    position: absolute; /* 絶対位置 */
    right: 0; /* 右端に配置 */
  font-weight: bolder; /* より太くする */
}

.time-class-match{
    position: absolute; /* 絶対位置 */
    right: 0; /* 右端に配置 */
  font-size:1vw;
}

.msg-class-mismatch{
  background-color: #eee; /* 灰色 */
  padding: 5px; /* 文字周りの余白 */
  border-radius: 10px; /* 角丸 */
  display: inline-block; /* 文字数に合わせて幅が変わるように */
}

.name-class-mismatch{
  font-weight: bolder; /* より太くする */
}

.time-class-mismatch{
  font-size:1vw;
}

#publicroom{
    width:20vw;             /* 横幅 */
    height: 5vh;               /* 高さ */
    border: 2px solid black;      /* 枠線 */
    background-color: #f9f9f9;   /* 背景色 */
    display: none;
    position: absolute;
    top: calc(90vh); /* ユーザー名入力ボックスの下に配置 */
    left: 50%;
    text-align: center;
    font-size:3vh;
}

/* ボタンにカーソルを合わせたとき（ホバー時）のスタイル */
#TalkingStart:hover {
    background-color: #45a049;
}

* {
    box-sizing: border-box;
  }

.activeDiv{
    display: flex;  /* 子要素を横並びに */
}
        </style>
    </head>
    <body>
        <div class="activeDiv"><div id="Allactiveuser"></div><div id="Roomactiveuser"></div></div>
        <strong><div id="helloID"></div></strong>
        <div id="container"><div class="chat-box" id="chat-box" name="talkpage"></div><div id="userlist" class="userlist" name="talkpage"></div></div>
        <textarea id="MessageText" class="MessageText" placeholder="メッセージを入力..." name="talkpage"></textarea>
        <p id="roomDetail" name="talkpage">あなたは現在公開ルームに参加しています。</p>
        <br><input type="text" placeholder="ルーム番号を入力してください(1-10文字)" id="roomID" name="talkpage"><button class="join" id="join" name="talkpage">参加</button>
<button id="publicroom">公開部屋に戻る</button>
        <h1 id="TalkingSite" name="startpage">トークサイト</h1> 
        <input type="text" class="userName" placeholder="ユーザー名を入力してください(3-10文字)" name="startpage" id="userName">
        <button id="TalkingStart" name="startpage">トークを始める</button>
        <script type="module">
            //インポートするための文
// Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
import { getDatabase, ref, push, set, onChildAdded, remove, onChildRemoved, onValue , onChildChanged} from "https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js"; // 追加
import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-analytics.js";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries
// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
    apiKey: "AIzaSyALbxISZQW6hx97fFEOH7YkSPHZkHNwq6Y",
    authDomain: "test-6aa38.firebaseapp.com",
    databaseURL: "https://test-6aa38-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "test-6aa38",
    storageBucket: "test-6aa38.firebasestorage.app",
    messagingSenderId: "327819738458",
    appId: "1:327819738458:web:c04cc599a731e1aa238763",
    measurementId: "G-QXNG59XZES"
};
          
// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getDatabase(app);

//実際の処理を記述
//html要素を取得
const EnteruserName = document.querySelector('[id="userName"]');
const privateroomID = document.querySelector(`[id="roomID"]`)

//グローバル変数の宣言
let year,month,day,hours,minutes,seconds,userName,RoomID,Roomcount,Allcount;
let countjoin = 0;
let countpublic = 0;
let Roomactivecount = 0;
let Allactivecount = 0;
let ToroomID = "Public";
let Userroom;//IDを保存するルーム
let AllUserroom = ref(db, 'chatsite/AlluserID');
let ID;
let RoomIdArray = [];//IDを格納する配列
let AllIdArray = [];//IDを格納する配列
let RoomActiveuser = document.getElementById('Roomactiveuser');
RoomActiveuser.textContent = "ルームアクティブ..人";
let AllActiveuser = document.getElementById('Allactiveuser');
AllActiveuser.textContent = "サイトアクティブ..人";
let userlist = document.getElementById('userlist');
let userAgent = navigator.userAgent;
userAgent = userAgent.replace(/[.#$\[\]\/]/g, '');
let Received = false;

let SaveIDroom = ref(db, 'chatsite/SaveIDroom/' + userAgent);
onChildAdded(SaveIDroom, function (snapshot) {
    if (ID){}else{
    let data = snapshot.val();
    ID = data.ID;
    Received = true;
    console.log(ID + "true");
    }
    });

setTimeout(function() {
    if(Received == false){
        ID = Math.random().toString(32).substring(2);//IDをランダムで生成(識別のため)
        push(SaveIDroom, {ID:ID});   
        console.log(ID + "false");
    }
},1000);

EnteruserName.addEventListener('keydown', function(event) {
    if (event.key === "Enter") {
        StartClick();
    }
});

privateroomID.addEventListener('keydown', function(event) {
    if (event.key === "Enter") {
        join();
    }
});

// textarea 要素を取得
const MessageText = document.getElementById("MessageText");

// Enter キーが押されたときの処理
MessageText.addEventListener("keydown", function(event) {
    // Shift が押されていない Enter キーを押した場合、改行を防止
    if (event.key === "Enter" && !event.shiftKey) {
        sendMessage();
        event.preventDefault();  // Enter キーのデフォルト動作（改行）をキャンセル
        let chatbox = document.getElementById('chat-box');
        chatbox.scrollTop = chatbox.scrollHeight
    }
});

//時間を更新する関数
function updatatime(){
    const currentDate = new Date();
    year = currentDate.getFullYear();  //西暦
    month = currentDate.getMonth() + 1;  //月 
    day = currentDate.getDate();  //日
    hours = currentDate.getHours();  //時間
    minutes = currentDate.getMinutes();  //分
    seconds = currentDate.getSeconds();  //秒
}

//メッセージを送信するための関数
function sendMessage(){
    updatatime();
    const text = document.getElementById('MessageText').value;
    push(RoomID, {Name:userName, Type:"MSG", Text:text, Year:year, Month:month, Day:day, Hours:hours, Minutes:minutes, Seconds:seconds, userAgent:userAgent ,ID:ID});
    document.getElementById('MessageText').value = '';
}

//スタートページのボタンが押されたら呼び出される関数
function StartClick(){
    userName = document.getElementById('userName').value;
    if(3 <= userName.length && userName.length <= 10 ){
        let StartPages = document.querySelectorAll('[name="startpage"]');
        Public();

        // 取得した要素を非表示にする
        StartPages.forEach(function(StartPage) {
        StartPage.style.display = "none";
        TalkStart();
        });
    }
    else if(userName.length < 3){
        alert("ユーザネームが短すぎます。")
    }
    else if(userName.length > 10){
        alert("ユーザーネームが長すぎます。")
    }
}

//ユーザーネームが登録されトークが始まるときに呼び出される関数
function TalkStart(){
    document.getElementById("helloID").textContent = `ようこそ ${userName} さん`;
    // name属性が'talkpage'の要素をすべて取得
    let TalkPages = document.querySelectorAll('[name="talkpage"]');

    // 各要素のdisplayを'block'にして表示
    TalkPages.forEach(function(TalkPage) {
        TalkPage.style.display = 'block';
    });
}

//公開ルームに移動する関数
function Public(){
    countpublic++;
    let i = countpublic;
    RoomID = ref(db, 'chatsite/message/pablicroom');
    Userroom = ref(db, 'chatsite/userID/pablicroom');
    push(RoomID, {Name:userName,Type:"Login"});
    document.getElementById('roomID').value = '';
    document.getElementById("chat-box").textContent = ``;
    document.getElementById('roomDetail').innerHTML = `あなたは現在公開ルームに参加しています。`;
    setTimeout(function() {
    CountStart();
    }, 3000);
    //MSG受信処理
    onChildAdded(RoomID, function (snapshot) {
    if(countpublic <= i){
    let data = snapshot.val();
    let chatbox = document.getElementById('chat-box');
    if (data.Name !== undefined && data.Text !== undefined && data.Type == "MSG"){
        const msgDiv = document.createElement('div');
                const name = document.createElement('span');
                const msg = document.createElement('span');
                const time = document.createElement('span');
                name.textContent = `${data.Name}(ID:${data.ID})`;
                msg.textContent = data.Text;
                time.textContent = `${data.Year}/${data.Month}/${data.Day}/${data.Hours}:${data.Minutes}:${data.Seconds}`;
                if(data.userAgent == userAgent){
                name.className = `name-class-match`;
                msg.className = `msg-class-match`;
                time.className = `time-class-match`;
                msgDiv.appendChild(name);
                msgDiv.appendChild(document.createElement('br'));            
                msgDiv.appendChild(msg);
                msgDiv.appendChild(document.createElement('br'));    
                msgDiv.appendChild(time);
                chatbox.appendChild(msgDiv);
                chatbox.appendChild(document.createElement('br'));
                }
                else if(data.userAgent !== userAgent){
                name.className = `name-class-mismatch`;
                msg.className = `msg-class-mismatch`;
                time.className = `time-class-mismatch`;
                msgDiv.appendChild(name);
                msgDiv.appendChild(document.createElement('br'));            
                msgDiv.appendChild(msg);
                msgDiv.appendChild(time);
                chatbox.appendChild(msgDiv);
                chatbox.appendChild(document.createElement('br'));                
                }  
    }
    else if(data.Type == "Login"){
    let Login = `${data.Name}が参加しました`
    chatbox.appendChild(document.createTextNode(Login));
    chatbox.appendChild(document.createElement('br'));
    setTimeout(function() {
    const dataRef = snapshot.ref;
    remove(dataRef);
    }, 3000);
    }
    }
    });
}

function join(){
    countpublic++;
    let i = countpublic;
    ToroomID = document.getElementById('roomID').value;
    console.log(ToroomID);
    if(1 <= ToroomID.length && ToroomID.length <= 10){
        RoomID = ref(db, 'chatsite/message/privateroom/' + ToroomID);
        Userroom = ref(db, 'chatsite/userID/privateroom/' + ToroomID);
        push(RoomID, {Name:userName,Type:"Login"});
        document.getElementById('roomID').value = '';
        document.getElementById("chat-box").textContent = ``;
        document.getElementById('roomDetail').innerHTML = `あなたは現在 ${ToroomID} ルームに参加しています。`;
        // name属性が'talkpage'の要素をすべて取得
        let Publicrooms = document.querySelectorAll('[id="publicroom"]');

        // 各要素のdisplayを'block'にして表示
        Publicrooms.forEach(function(Publicroom) {
        Publicroom.style.display = 'block';
        });
        RoomActiveuser.textContent = "ルームアクティブ..人"; 
        setTimeout(function() {
        CountStart();
        }, 3000);
        //MSG受信処理
        onChildAdded(RoomID, function (snapshot) {
        if(countpublic <= i){
        let data = snapshot.val();
        let chatbox = document.getElementById('chat-box');
        if (data.Name !== undefined && data.Text !== undefined && data.Type == "MSG"){
                const msgDiv = document.createElement('div');
                const name = document.createElement('span');
                const msg = document.createElement('span');
                const time = document.createElement('span');
                name.textContent = `${data.Name}(ID:${data.ID})`;
                msg.textContent = data.Text;
                time.textContent = `${data.Year}/${data.Month}/${data.Day}/${data.Hours}:${data.Minutes}:${data.Seconds}`;
                if(data.userAgent == userAgent){
                name.className = `name-class-match`;
                msg.className = `msg-class-match`;
                time.className = `time-class-match`;
                msgDiv.appendChild(name);
                msgDiv.appendChild(document.createElement('br'));            
                msgDiv.appendChild(msg);
                msgDiv.appendChild(document.createElement('br'));    
                msgDiv.appendChild(time);
                chatbox.appendChild(msgDiv);
                chatbox.appendChild(document.createElement('br'));
                }
                else if(data.userAgent !== userAgent){
                name.className = `name-class-mismatch`;
                msg.className = `msg-class-mismatch`;
                time.className = `time-class-mismatch`;
                msgDiv.appendChild(name);
                msgDiv.appendChild(document.createElement('br'));            
                msgDiv.appendChild(msg);
                msgDiv.appendChild(time);
                chatbox.appendChild(msgDiv);
                chatbox.appendChild(document.createElement('br'));                
                }  
            }
    else if(data.Type == "Login"){
    let Login = `${data.Name}が参加しました`
    chatbox.appendChild(document.createTextNode(Login)); 
    chatbox.appendChild(document.createElement('br'));
    setTimeout(function() {
    const dataRef = snapshot.ref;
    remove(dataRef);
    }, 3000);
    }
            }
        });
    }
    else if(ToroomID.length < 1){
        alert("ルームIDが短すぎます。")
    }
    else if(ToroomID.length > 10){
        alert("ルームIDが長すぎます。")
    }
}

function Publicjoin(){
   let Publicrooms = document.querySelectorAll('[id="publicroom"]');
   Public();

   // 取得した要素を非表示にする
   Publicrooms.forEach(function(Publicroom) {
   Publicroom.style.display = "none";
   });
}

//IDの削除+追加+取得(参加している部屋)
setInterval(function() {
    const currentDate = new Date();
    const seconds = currentDate.getSeconds();
    
      if(Roomcount !== undefined && userName){
        if(Roomcount !== seconds){
          Roomcount = seconds;
            if(seconds % 3 == 0){
              remove(Userroom);
              RoomIdArray=[];
            }
            else if(seconds % 3 == 1){
              push(Userroom, {ID:userName});
            }
            else if(seconds % 3 == 2){
              const Activeusercount = RoomIdArray.length;
                if (Activeusercount > 0){
                RoomActiveuser.textContent = `ルームアクティブ${Activeusercount}人`;
                }
                else{
                RoomActiveuser.textContent = "ルームアクティブ..人";  
                }
            }
        }
      }
      else{
        Roomcount = seconds;
      }

      if(Allcount !== undefined && userName){
        if(Allcount !== seconds){
          Allcount = seconds;
            if(seconds % 3 == 0){
              remove(AllUserroom);
              AllIdArray=[];
            }
            else if(seconds % 3 == 1){
              push(AllUserroom, {ID:userName});
            }
            else if(seconds % 3 == 2){
              const Activeusercount = AllIdArray.length;
                if (Activeusercount > 0){
                AllActiveuser.textContent = `サイトアクティブ${Activeusercount}人`;
                userlist.textContent = "アクティブ";
                for (let I = 0; I <= Activeusercount - 1; I++) {
                userlist.appendChild(document.createElement('br'));
                userlist.appendChild(document.createTextNode(AllIdArray[I]));
                }
                }
                else{
                AllActiveuser.textContent = "サイトアクティブ..人";  
                }
            }
        }
      }
      else{
        Allcount = seconds;
      }    
  }, 1);
  
function CountStart(){
    Roomactivecount++;
    let i = Roomactivecount;
    Allactivecount++;
    let p = Roomactivecount;
    onChildAdded(Userroom, function (snapshot) {
        if(Roomactivecount <= i){
            let data = snapshot.val();
            RoomIdArray.push(data.ID);
            RoomIdArray = [...new Set(RoomIdArray)];
        }
    });

    onChildAdded(AllUserroom, function (snapshot) {
        if(Allactivecount <= p){
            let data = snapshot.val();
            AllIdArray.push(data.ID);
            AllIdArray = [...new Set(AllIdArray)];
        }
    });
}

document.getElementById("TalkingStart").addEventListener("click", StartClick);
document.getElementById("join").addEventListener("click", join);
document.getElementById("publicroom").addEventListener("click", Publicjoin);
        </script>
    </body>
</html>
